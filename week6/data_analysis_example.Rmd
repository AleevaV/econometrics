---
title: "Анализ реальных данных на примере РЛМС"
author: "AleevaV"
date: "22 01 2020"
output:
  word_document: default
  pdf_document: default
---
Исследователь Вовочка решил попробовать свои силы и провести исследование, чтобы выявить факторы, влияющие на доход людей, на реальных данных. Но один он не может справиться, поэтому Вам необходимо помочь Вовочке в этом.

В рамках данного задания мы будем проводить небольшое эконометрическое исследование на данных Российского мониторинга экономического положения и здоровья населения (РМЭЗ, он же RLMS). Опишем предварительные шаги, которые Вовочке и Вам надо будет сделать, прежде чем приступать к работе с данными.

1) Первый шаг — это получить данные. Данные РМЭЗ являются открытыми и после простой процедуры регистрации доступны для скачивания на сайте Высшей Школы Экономики. В рамках этого задания Вовочке посоветовали взять репрезентативную выборку по индивидам за 2013 год - волна 22 (нужный файл называется r22i_os_31.sav).

NB! Если на сайте РМЭЗ при скачивании репрезентативной выборки, скачалась полная (r22iall_31.sav), то не стоит паниковать, так как из полной выборки сделать репрезентативную можно одной командой, отобрав наблюдения по условию origsm=1 :)
2) Для загрузки данных в R Вовочке посоветовали воспользоваться пакетом rlms. Описание и инструкция по установке. Пакет rlms автоматически выполняет несколько процедур по очистке данных. Если загружать данные без его использования, то необходимо перекодировать все пропуски в данных ("нет ответа", "затрудняюсь ответить" и т.д.) в NA самостоятельно.

Замечание. Если функция rlms_read выдаёт ошибку при чтении файла, откатите пакет haven до более старой версии. Версия 1.1.1. пакета haven перестала читать некоторые sav файлы. Разработчики пакета haven в курсе этой ошибки и мы надеемся, что её в ближайшем будущем поправят. Откатиться можно с помощью команды: devtools::install_version("haven", version = "1.1.0"). Либо скачать архивную версию пакета руками, разархивировать её, и установить командой devtools::install_local("папка_с_разархивированным_пакетом").

```{r, include=FALSE}
library("haven")
library("pander")
library("knitr")
library("lmtest")
library("psych")
library("memisc")
library("psych")
library("dplyr")
library("knitr")
library("rlms")
library("sandwich")
library("ggplot2")
library("scales")

opts_chunk$set(echo = FALSE, message = FALSE)
```
3) Для исследования Вовочка составил массив данных с отобранными переменными:

Заработной платой на основе вопроса rj13.2
Возрастом на основе переменной rh6 и года проведения опроса
Полом на основе переменной rh5
Образованием на основе переменной r_diplom
Типом населенного пункта на основе переменной status
Удовлетворенностью работой в целом на основе переменной rj1.1.1.
Чтобы получить такой же массив, есть ряд моментов, нужно сделать следующие шаги:

1) Подгрузить пакеты и файл.
```{r}
df <- rlms_read("r22i_os_31.sav")
```
2) Отобрать только 6 переменных, описанных выше.
3) Создать переменную возраст. Год рождения респондента (переменная rh6) - числовая переменная, чтобы перейти от года рождения к возрасту нужно, как несложно догадаться, вычесть из года проведения опроса (2013) год рождения респондента (возможными расхождениями, связанными с месяцем рождения, можно пренебречь).
```{r}

data0 <- transmute(df,
               wage = rj13.2,
               age = 2013 - rh6,
               sex = rh5,
               educ = r_diplom,
               place = status,
               satisf = rj1.1.1)
```
4) Отобрать только два типа населённого пункта: город и областной центр (должно остаться 10692 записи).
```{r}
data1 <- data0[data0$place %in% c(NA, '1','2'),]

```
5) Отобрать только две категории степени удовлетворенности работой в целом: полностью удовлетворен и скорее удовлетворен (должно остаться 9089 записей).
```{r}
data2 <- data1[data1$satisf %in% c(NA, '1','2'),]

```
6) Отобрать только тех людей, у кого образование входит в одну из следующих категорий:

Категория 1: окончил 0 - 6 классов;
Категория 2: незаконченное среднее образование (7 - 8 кл);
Категория 3: незаконченное среднее образование (7 - 8 кл) + что-то еще;
Категория 4: законченное среднее образование;
Категория 5: законченное среднее специальное образование;
Категория 6: законченное высшее образование и выше;
То есть таким образом Вы выбросите варианты "Затрудняюсь ответить", "Отказ от ответа" и "Нет ответа" (должно остаться 9089 записей).
```{r}
data3 <- data2[data2$educ %in% c(NA, '1','2','3','4','5','6'),]

```
7) Из переменной тип населенного пункта сделать дамми-переменную, равную 1 для города и 0 для областного центра.

8) Из переменной удовлетворённость работой сделать дамми-переменную, равную 1 для полностью удовлетворен и 0 для скорее удовлетворен.

9) Из переменной пол сделать дамми-переменную, равную 1 мужчин и 0 для женщин.

10) Нет оснований считать, что эффект, к примеру, получения образования в виде 7-8 классов по сравнению с 0-6 классами такой же, как у получения высшего образования по сравнению со средним специальным образованием (оба примера - соседние категории), поэтому переменную образование необходимо превратить в набор фиктивных переменных. Использовать будем следующие категории:

Незаконченное среднее образование (категории от 1 до 3 из пункта 6)
Законченное среднее образование (категория 4 из пункта 6)
Законченное среднее специальное образование (категория 5 из пункта 6)
Законченное высшее образование (категория 6 из пункта 6)
В итоге Вы должны получить 4 фиктивные переменные, отвечающие за принадлежность респондента к одной из этих категорий.
```{r}
data4 <- mutate(data3,
       city = ifelse(place=='2',1,0),
       satisf = ifelse(satisf=='1',1,0),
       sex = ifelse(sex=='1',1,0),
       educ_l = ifelse(educ<4,1,0),
       educ_m = ifelse(educ==4,1,0),
       educ_ms = ifelse(educ==5,1,0),
       educ_h = ifelse(educ==6,1,0))
data5 <- select(data4,-educ,-place)
```
11) В полученном массиве данных должно быть 9089наблюдений.

```{r}
dim(data5)
```
12) Создать массив данных, очищенный от пропущенных наблюдений, NA. Таким образом, у Вас должно получиться 2984 наблюдения в массиве без NA! Если оно другое, значит, где-то ошибка и надо пересмотреть предыдущие пункты.

```{r}
data_clear <- na.omit(data5)
dim(data_clear)
```
Теперь, когда данные скачаны, загружены в R и отобраны в массив, самое сложное уже позади! Вы можете приступать к выполнению задания, но не забудьте загрузить необходимые пакеты! :)

Задания 1 и 2 нужно делать по массиву данных с 9089 наблюдениями, то есть с массивом, где есть NA :)

1. Исследователь Вовочка захотел более подробно изучить возрастную структуру полученных им данных и обнаружил, что максимальный возраст респондента в его выборке равен
```{r}
max(data5$age)
```
2. Как настоящий исследователь Вовочка решил проверить, сколько пропущенных значений в переменной, которая представляет для него главный интерес, в заработной плате. Оно равно

```{r}
sum(is.na(data5$wage))
```
Поняв, что так дело не пойдет, Вовочка как любой неопытный исследователь, решил бороться с пропусками простым и робастным методом, просто очистил данные от них :) Сделаем так и мы. То есть здесь и далее будем работать только с массивом из 2984 наблюдений, где нет NA.

3.Вовочка решил показать на графике, какое же распределение имеет заработная плата. Посмотрев на гистограмму, Вовочка сделал следующий вывод

```{r}
#hist(data$wage, breaks = 50, main = "Гистограмма по доходам", xlab = "Заработная плата", ylab = "Частота")
```
 - Абсолютное большинство респондентов имеет доход до 50 тысяч рублей

4.Ниже представлены два графика, которые изобразил Вовочка. Деление на 0 и 1 Вовочка сделал по переменной пол. Но он забыл подписать ось X.
```{r}
ggplot(data = data_clear, aes(age)) + 
  geom_histogram(fill = "pink", binwidth = 10, color = "red") + 
  labs(title = "Гистограмма по возрасту", 
       x = "Возраст (в годах)", y = "Частота")+
  facet_grid(~sex)
```
5. Теперь Вовочка решил оценить влияние возраста, пола, 3 фиктивных переменных на образование (не включая фиктивную переменную на самый низкий уровень образования), фиктивной переменной на проживание в городе и удовлетворенности работой на заработную плату респондентов. Сначала он решил проверить регрессию на значимость в целом и получил следующее значение тестовой статистики:

```{r}
model <- lm(data = data_clear,wage ~ sex + age + educ_m + educ_ms + educ_h + city + satisf)
res <- summary(model)            
res$fstatistic
```
6.Какой вывод сделал Вовочка относительно значимости регрессии в целом?
- На любом разумном уровне значимости гипотеза о равенстве всех коэффициентов нулю отвергается. То есть как минимум один из коэффициентов значим и оказывает влияние на доход.

7. При проверке гипотезы о значимости коэффициента при переменной пол Вовочка хочет сравнить значение наблюдаемой статистики с критическим значением для уровнем значимости 5%, какое значение наблюдаемой статистики Вовочка должен использовать?

```{r}
res$coefficients
```
8. Сравнив наблюдаемое значение статистики с различными критическими значениями, Вовочка пришел к следующему выводу:

-На уровне значимости 1%, 5% и 10% коэффициент при дамми на пол значим. Мужчины получают в среднем выше доход, чем женщины

9.Вовочка решил посмотреть робастное стандартное отклонение для дамми на тип населённого пункта. Оно равно:

```{r}
coefs <- coeftest(model, vcov. = vcovHC(model))
pander(coefs[, 1:4])
```
-602.7

10. Также Вовочка провел тест на значимость коэффициента при дамми на удовлетворённость. Он сделал вывод, что коэффициент значим на 10%. Но Вовочка затруднятся с интерпретацией результата. Какова она?
```{r}
coefs
```
- Те, у кого удовлетворённость выше, получают заработную плату на 1326.24 рублей выше.
